#!/bin/bash

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –ø—Ä–∏ –ª—é–±–æ–π –æ—à–∏–±–∫–µ
set -e

echo "üê≥ –®–∞–≥ 1: –ó–∞–ø—É—Å–∫ Docker –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã..."
# -d –∑–∞–ø—É—Å–∫–∞–µ—Ç –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ
cd milvus-local
docker compose up -d

echo "‚è≥ –®–∞–≥ 2: –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ MySQL (–æ–±—ã—á–Ω–æ 15-20 —Å–µ–∫)..."
# –ñ–¥–µ–º, –ø–æ–∫–∞ MySQL –Ω–∞—á–Ω–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ø–æ—Ä—Ç—É 3306
until docker exec mysql-server mysqladmin ping -h "localhost" --silent; do
    echo "   ...–±–∞–∑–∞ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –∂–¥–µ–º..."
    sleep 3
done
echo "‚úÖ MySQL –≥–æ—Ç–æ–≤!"

cd ../

echo "üì¶ –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Python –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
if [ ! -d "venv" ]; then
    python3 -m venv venv
fi

source venv/bin/activate

echo "üõ† –®–∞–≥ 4: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫ (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –≤—Ä–µ–º—è)..."
pip install --upgrade pip
pip install -r requirements.txt

echo "üìÇ –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π..."
# –ó–¥–µ—Å—å —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞—Å—Ç –±–∞–∑—ã –∏ —Ç–∞–±–ª–∏—Ü—ã –≤ MySQL –∏ Milvus
python3 migrate.py

echo "-----------------------------------------------"
echo "üéâ –í–°–Å –ì–û–¢–û–í–û!"
echo "–ü—Ä–æ–µ–∫—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã."
echo "–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É, –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ:"
echo "source venv/bin/activate"
echo "-----------------------------------------------"